<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PC Monitor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/index.css">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container text-center mt-4">
    <!-- Top Row -->
    <div class="row justify-content-center mt-4">
      <div class="col-md-6">
        <div class="section-container">
          <div class="gauge" id="cpu-gauge" style="--value: 0deg;">
            <div class="gauge-text" id="cpu-gauge-text">0</div>
            <div class="gauge-label">CPU %</div>
          </div>
          <div class="text-stats">
            <p id="cpu_temp">CPU Temp: Loading...</p>
            <p id="cpu_power">CPU Power: Loading...</p>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="section-container">
          <div class="gauge" id="gpu-gauge" style="--value: 0deg;">
            <div class="gauge-text" id="gpu-gauge-text">0</div>
            <div class="gauge-label">GPU %</div>
          </div>
          <div class="text-stats">
            <p id="gpu_temp">GPU Temp: Loading...</p>
            <p id="gpu_power">GPU Power: Loading...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Row -->
    <div class="row justify-content-center mt-4">
      <div class="col-md-3">
        <div class="section-container">
          <div class="gauge" id="ram-gauge" style="--value: 0deg;">
            <div class="gauge-text" id="ram-gauge-text">0</div>
            <div class="gauge-label">RAM %</div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="section-container disk-network-container">
          <div class="disk-stats">
            <p>SSD M2 (C:)</p>
            <div class="progress"><div id="disk-c-bar" class="progress-bar" role="progressbar"></div></div>
            <p>SSD M2 (F:)</p>
            <div class="progress"><div id="disk-f-bar" class="progress-bar" role="progressbar"></div></div>
            <p>SSD Sata (D:)</p>
            <div class="progress"><div id="disk-d-bar" class="progress-bar" role="progressbar"></div></div>
          </div>

           <!-- Network Stats -->
           <div class="network-stats">
            <div class="network-speed-container">
              <p><span>&#8679;</span> <span id="network-upload">0</span></p>
              <p><span>&#8681;</span> <span id="network-download">0</span></p>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="section-container">
          <div class="gauge">
            <div class="gauge-text" id="current-time">00:00:00</div>
            <div class="gauge-label" id="current-date">Loading...</div>
          </div>
        </div>
      </div>
      </div>
    </div>
  </div> 

  <script>
  async function fetchData() {
    const startTime = Date.now(); 

    try {
      const response = await fetch("http://192.168.1.72:5000/api/stats");
      const data = await response.json();

      // CPU
      const cpuUsage = parseFloat(data.cpu_usage) || 0; 
      const cpuDegrees = (cpuUsage / 100) * 360;
      document.getElementById("cpu-gauge").style.setProperty("--value", cpuDegrees + "deg");
      document.getElementById("cpu-gauge-text").textContent = Math.round(cpuUsage);
      document.getElementById("cpu_temp").innerText = `CPU Temp: ${data.cpu_temp || "N/A"}°`;
      document.getElementById("cpu_power").innerText = `CPU Power: ${data.cpu_power || "N/A"}`;

      // GPU
      const gpuUsage = parseFloat(data.gpu_usage) || 0;
      const gpuDegrees = (gpuUsage / 100) * 360;
      document.getElementById("gpu-gauge").style.setProperty("--value", gpuDegrees + "deg");
      document.getElementById("gpu-gauge-text").textContent = Math.round(gpuUsage);
      document.getElementById("gpu_temp").innerText = `GPU Temp: ${data.gpu_temp || "N/A"}°`;
      document.getElementById("gpu_power").innerText = `GPU Power: ${data.gpu_power || "N/A"}`;

      // RAM
      const totalRamGB = 32;
      const usedRamGB = parseFloat(data.ram_usage_gb) || 0;
      const ramPercent = (usedRamGB / totalRamGB) * 100;
      const ramDegrees = (ramPercent / 100) * 360;
      document.getElementById("ram-gauge").style.setProperty("--value", ramDegrees + "deg");
      document.getElementById("ram-gauge-text").textContent = Math.round(ramPercent);

      // Disks
      function updateDiskBar(diskId, value) {
        const diskElement = document.getElementById(diskId);
        if (diskElement) {
          const percent = parseFloat(value) || 0;
          diskElement.style.width = percent + "%";
          diskElement.textContent = percent.toFixed(1) + "%";
        }
      }

      updateDiskBar("disk-c-bar", data.disk_c_usage);
      updateDiskBar("disk-f-bar", data.disk_f_usage);
      updateDiskBar("disk-d-bar", data.disk_d_usage);  

      // Network Speed Conversion (Auto-switch between KB/s & Mbps)
      function formatSpeed(speedKBs) {
        const speedMbps = (speedKBs * 8) / 1024; // Convert KB/s to Mbps
        return speedMbps >= 1 
          ? `${speedMbps.toFixed(1)} Mbps` 
          : `${speedKBs.toFixed(1)} KB/s`;
      }

      const downloadSpeedKBs = (parseFloat(data.network_download) || 0) / 1024;
      const uploadSpeedKBs = (parseFloat(data.network_upload) || 0) / 1024;

      document.getElementById("network-download").textContent = formatSpeed(downloadSpeedKBs);
      document.getElementById("network-upload").textContent = formatSpeed(uploadSpeedKBs);

    } catch (error) {
      console.error("Error fetching system data:", error);
    }

    // Ensure the next update always gets scheduled
    const elapsedTime = Date.now() - startTime;
    const nextUpdateIn = Math.max(500 - elapsedTime, 500); 
    setTimeout(fetchData, nextUpdateIn);
  }

  fetchData();


    function updateTimeAndDate() {
      const now = new Date();
      
      // Format time as HH:MM:SS
      const timeString = now.toLocaleTimeString("en-GB", { hour12: false });

      // Format date as YYYY-MM-DD
      const dateString = now.toLocaleDateString("en-GB", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
      });

      // Update elements
      document.getElementById("current-time").textContent = timeString;
      document.getElementById("current-date").textContent = dateString;
    }
    setInterval(updateTimeAndDate, 1000);
    updateTimeAndDate(); 

  </script>

</body>
</html>
